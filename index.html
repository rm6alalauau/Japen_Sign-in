<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0,shrink-to-fit=no">
  <title>打卡</title>

  <style>
    :root {
      --md3-color-primary: #6200EE;
      --md3-color-on-primary: #ffffff;
      --md3-color-surface: #FFFFFF;
      --md3-color-on-surface: #1C1B1F;
      --md3-color-surface-variant: #F3EDF7;
      --md3-color-outline: #79747E;

      --md3-shape-corner: 12px;
      --md3-elevation: 0 1px 2px rgba(0, 0, 0, 0.15);
      --md3-elevation-high: 0 4px 8px rgba(0, 0, 0, 0.2);
      --md3-font-size-title: 1.25rem;
      --md3-font-size-body: 1rem;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    body {
      font-family: "Roboto", sans-serif;
      background: var(--md3-color-surface);
      color: var(--md3-color-on-surface);
      line-height: 1.5;
    }

    /* 上方標題列 */
    .app-bar {
      background: var(--md3-color-primary);
      color: var(--md3-color-on-primary);
      padding: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: var(--md3-elevation);
    }
    .app-bar h1 {
      font-size: 1.5rem;
      margin: 0;
    }

    /* 主要容器 */
    .container {
      width: 100%;
      max-width: 600px;
      margin: 0 auto;
      padding: 16px;
    }

    /* 說明文字 */
    .description {
      background: var(--md3-color-surface-variant);
      padding: 12px;
      border-radius: var(--md3-shape-corner);
      margin-bottom: 16px;
      box-shadow: var(--md3-elevation);
      font-size: var(--md3-font-size-body);
    }

    /* 單一按鈕：最近地點簽到 */
    .single-checkin-button {
      background: var(--md3-color-primary);
      color: var(--md3-color-on-primary);
      border: none;
      border-radius: var(--md3-shape-corner);
      padding: 12px;
      font-size: 1rem;
      cursor: pointer;
      box-shadow: var(--md3-elevation);
      transition: background 0.2s;
      margin-bottom: 16px;
      width: 100%;
    }
    .single-checkin-button:hover {
      background: #4B00C3;
    }

    /* 集點卡 */
    .stamp-title {
      font-size: var(--md3-font-size-title);
      margin-bottom: 8px;
    }
    .stamp-card {
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      margin-top: 20px;
    }

    /* stamp-slot: flex + center, 確保文字或圖片都居中 */
    .stamp-slot {
      width: 120px;
      height: 120px;
      background-color: var(--md3-color-surface);
      border: 2px dashed var(--md3-color-outline);
      border-radius: var(--md3-shape-corner);
      box-shadow: var(--md3-elevation);

      display: flex;              /* 關鍵：使用 flex 來置中 */
      align-items: center;        /* 垂直置中 */
      justify-content: center;    /* 水平置中 */
      text-align: center;         /* 多行文字可再置中(保險) */

      overflow: hidden;
      font-size: 0.9rem;
      margin: 0; /* 移除任何預設外距 */
    }

    .stamp-slot.stamped {
      border: none;
      background-color: #E0DAF6;
    }

    /* stamp-image: 盡量放大、等比例 */
    .stamp-image {
      max-width: 90%;
      max-height: 90%;
      object-fit: contain;
      display: block;
      margin: 0 auto;
    }

    /* 蓋章動畫 */
    .stamp-animation {
      animation: stamp-pop 0.5s ease;
    }
    @keyframes stamp-pop {
      0% {
        transform: scale(2);
        opacity: 0;
      }
      50% {
        transform: scale(0.8);
        opacity: 1;
      }
      100% {
        transform: scale(1);
      }
    }

    /* 浮動按鈕 (FAB) */
    .fab {
      position: fixed;
      bottom: 24px;
      right: 24px;
      width: 56px;
      height: 56px;
      border-radius: 28px;
      background-color: var(--md3-color-primary);
      color: var(--md3-color-on-primary);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      cursor: pointer;
      box-shadow: var(--md3-elevation-high);
    }

    /* 禮物區塊 (預設隱藏) */
    #giftSection {
      display: none;
      margin-top: 20px;
      text-align: center;
    }

    /* Toast 元件 */
    #toast {
      visibility: hidden;
      min-width: 200px;
      max-width: 80%;
      background-color: rgba(0, 0, 0, 0.85);
      color: #fff;
      text-align: center;
      border-radius: 8px;
      padding: 12px;
      position: fixed;
      z-index: 9999;
      left: 50%;
      bottom: 40px;
      transform: translateX(-50%);
      opacity: 0;
      transition: visibility 0s, opacity 0.3s ease-in-out;
      font-size: 0.95rem;
    }
    #toast.show {
      visibility: visible;
      opacity: 1;
    }
  </style>
</head>

<body>

  <!-- 上方標題列 -->
  <div class="app-bar">
    <h1>打卡</h1>
  </div>

  <div class="container">
    <!-- 說明文字 -->
    <div class="description">
      <p>允許定位後，可點擊「簽到」按鈕或直接在下方查看集點卡狀態。</p>
      <p>若你已經身處該地點 500 公尺範圍內，即可成功蓋章</p>
    </div>

    <!-- 單一按鈕：最近地點簽到 -->
    <button class="single-checkin-button" id="checkinBtn">
      簽到
    </button>

    <!-- 集點卡區域 -->
    <h2 class="stamp-title">我的集點卡</h2>
    <div id="stampCard" class="stamp-card"></div>

    <!-- 解鎖禮物區塊 -->
    <div id="giftSection">
      <h2>恭喜解鎖禮物！</h2>
      <p>您已經集滿所有景點，快來領取專屬電子桌布：</p>
      <!-- 以下連結請換成你自己的檔案路徑/連結 -->
      <a href="https://example.com/myGift.png" target="_blank">
        <img src="https://example.com/myGiftThumbnail.png" style="max-width: 200px;">
      </a>
    </div>
  </div>

  <!-- 浮動按鈕 (FAB) ，可自行改成其他用途 -->
  <div class="fab" onclick="scrollToTop()">
    ↑
  </div>

  <!-- Toast 容器 -->
  <div id="toast"></div>

  <script>
    /*************************************************************************
     * 你在 Apps Script 部署後得到的 Web App URL
     * e.g. https://script.google.com/macros/s/xxxxxx/exec
     * 記得用你自己的！
     *************************************************************************/
    const BASE_URL = 'https://script.google.com/macros/s/AKfycbwfVWaPebUgwrHWEfTvEkomcM5Hra12YAurH5aoczGx3vrZ2lAyw-cnDxGWMccKjVWnug/exec';

    // 從網址參數中取得 userId，若沒有就給 guest
    const urlParams = new URLSearchParams(window.location.search);
    let userId = urlParams.get('user') || 'guest';

    let locations = [];      // 從後端抓取的地點清單
    let userCheckIns = [];   // 已簽到的地點ID
    const CHECKIN_RADIUS = 500; // 0.5 公里

    // 頁面載入時
    window.onload = async function() {
      try {
        locations = await fetchLocationsData();
        userCheckIns = await fetchUserCheckIns(userId);
        renderStampCard();
        if (userCheckIns.length >= 9) {
          showGiftSection();
        }
      } catch (err) {
        console.error(err);
        showToast('初始化失敗，請稍後再試。');
      }
    };

    // 綁定「最近地點簽到」按鈕事件
    document.getElementById('checkinBtn').addEventListener('click', checkNearestLocation);

    // (1) 取得全部地點資料
    async function fetchLocationsData() {
      const url = `${BASE_URL}?action=getLocationsData`;
      const response = await fetch(url);
      if (!response.ok) {
        throw new Error('取得地點資料失敗');
      }
      return await response.json();
    }

    // (2) 取得該使用者的打卡紀錄
    async function fetchUserCheckIns(userId) {
      const url = `${BASE_URL}?action=getCheckInsByUser&userId=${encodeURIComponent(userId)}`;
      const response = await fetch(url);
      if (!response.ok) {
        throw new Error('取得打卡紀錄失敗');
      }
      return await response.json(); // 回傳 locationId 陣列
    }

    // (3) 顯示集點卡
    function renderStampCard() {
      const stampCardEl = document.getElementById('stampCard');
      stampCardEl.innerHTML = '';

      locations.forEach(loc => {
        const slot = document.createElement('div');
        slot.className = 'stamp-slot';

        // 是否已簽到？
        const isStamped = userCheckIns.includes(loc.id);
        if (isStamped) {
          // 已蓋章
          slot.classList.add('stamped');
          const stampImg = document.createElement('img');
          stampImg.className = 'stamp-image stamp-animation';
          stampImg.src = loc.stampImage || 'https://via.placeholder.com/120?text=STAMP';
          slot.appendChild(stampImg);
        } else {
          // 尚未蓋章：顯示地點名稱
          slot.textContent = loc.name;
        }

        stampCardEl.appendChild(slot);
      });
    }

    // (4) 最近地點簽到 -> 取得GPS -> 計算最近地點 -> 若距離<=500m -> 打卡
    function checkNearestLocation() {
      if (!navigator.geolocation) {
        showToast('你的裝置不支援 GPS 定位');
        return;
      }
      navigator.geolocation.getCurrentPosition(
        async position => {
          const userLat = position.coords.latitude;
          const userLng = position.coords.longitude;

          let nearestLoc = null;
          let minDist = Infinity;

          // 找最近地點
          locations.forEach(loc => {
            const dist = getDistanceFromLatLngInM(userLat, userLng, loc.lat, loc.lng);
            if (dist < minDist) {
              minDist = dist;
              nearestLoc = loc;
            }
          });

          if (!nearestLoc) {
            showToast('無法計算最近地點');
            return;
          }

          if (minDist <= CHECKIN_RADIUS) {
            // 在500m以內 -> call recordCheckin
            const result = await recordCheckin(userId, nearestLoc.id);
            if (result.status === 'success') {
              showToast(`成功簽到：${nearestLoc.name}`);
              refreshStampCard();
            } else if (result.status === 'already_checked_in') {
              showToast(`你已經在「${nearestLoc.name}」簽到過了`);
            } else {
              showToast(`簽到失敗：${result.message}`);
            }
          } else {
            // 超過500公尺
            showToast(`離最近地點「${nearestLoc.name}」約 ${Math.round(minDist)} 公尺，無法簽到`);
          }
        },
        error => {
          showToast('取得GPS失敗，請確認已允許定位');
        }
      );
    }

    // (5) 呼叫後端的 recordCheckin
    async function recordCheckin(userId, locationId) {
      const url = `${BASE_URL}?action=recordCheckin&userId=${encodeURIComponent(userId)}&locationId=${encodeURIComponent(locationId)}`;
      const response = await fetch(url);
      if (!response.ok) {
        throw new Error('recordCheckin API 錯誤');
      }
      return await response.json(); // {status, message}
    }

    // (6) 簽到後重新抓使用者簽到 -> 更新畫面
    async function refreshStampCard() {
      userCheckIns = await fetchUserCheckIns(userId);
      renderStampCard();
      if (userCheckIns.length >= 9) {
        showGiftSection();
      }
    }

    // (7) 顯示禮物區
    function showGiftSection() {
      const giftSec = document.getElementById('giftSection');
      if (giftSec) {
        giftSec.style.display = 'block';
      }
    }

    // (8) 計算兩點距離 (公尺) - Haversine
    function getDistanceFromLatLngInM(lat1, lng1, lat2, lng2) {
      function deg2rad(deg) { return deg * (Math.PI / 180); }
      const R = 6371000; // 地球半徑 (公尺)
      const dLat = deg2rad(lat2 - lat1);
      const dLng = deg2rad(lng2 - lng1);
      const a =
        Math.sin(dLat / 2) * Math.sin(dLat / 2) +
        Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) *
        Math.sin(dLng / 2) * Math.sin(dLng / 2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    }

    // (9) 浮動按鈕：捲動至頂
    function scrollToTop() {
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // (10) Toast 函式
    function showToast(message, duration = 3000) {
      const toast = document.getElementById("toast");
      toast.textContent = message;
      toast.classList.add("show");

      // 過幾秒後移除
      setTimeout(() => {
        toast.classList.remove("show");
      }, duration);
    }
  </script>

</body>
</html>
